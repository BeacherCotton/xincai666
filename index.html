<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>尝试唤醒微信支付</title>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#fff;color:#222;}
    h1{font-size:18px;margin-bottom:8px;}
    p{margin:6px 0;color:#555;}
    input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;}
    button{margin-top:12px;padding:10px 14px;border-radius:6px;border:none;background:#09bb07;color:#fff;font-size:16px;cursor:pointer;}
    #status{margin-top:10px;color:#666;font-size:14px;}
    #qr{margin-top:14px;}
    img.qr{width:200px;height:200px;border-radius:6px;border:1px solid #eee;}
  </style>
</head>
<body>
  <h1>唤醒微信支付（尝试）</h1>
  <p>说明：若在微信内请优先使用后端生成的 JSAPI 参数；否则尝试 deep link 唤醒，失败则展示二维码。</p>

  <!-- 1) 在这里放入 payUrl（服务器返回的 weixin:// 链接），务必去掉反斜线 -->
  <label>weixin deep link：</label>
  <input id="payUrl" value="weixin://wxpay/bizpayurl?pr=dcCnZhBz3" />

  <label style="display:block;margin-top:8px;">（可选）如你后端注入 wx.chooseWXPay 所需参数，请把对象赋给全局变量 WX_PAY_CONFIG</label>
  <pre id="debug" style="display:none;"></pre>

  <button id="payBtn">立即唤醒 / 发起支付</button>
  <div id="status"></div>
  <div id="qr"></div>

<script>
/*
  使用说明：
  - 若后端可提供 JSAPI 支付参数（wxconfig 与 chooseWXPay 所需），请在页面中注入：
      window.WX_PAY_CONFIG = {
        wxConfig: { appId, timestamp, nonceStr, signature },   // 用于 wx.config
        payParams: { timestamp, nonceStr, package, signType, paySign } // 用于 wx.chooseWXPay
      };
    并确保 wx.config 已按微信文档初始化（或使用下面的 initWxSdkFromConfig 函数）。
  - 若无法提供，则脚本会尝试直接唤醒 weixin:// deep link（在微信内往往不稳定）。
  - deep link 格式必须为 weixin://wxpay/bizpayurl?pr=YOUR_PR
*/

(function(){
  const payBtn = document.getElementById('payBtn');
  const statusEl = document.getElementById('status');
  const qrEl = document.getElementById('qr');
  const payUrlInput = document.getElementById('payUrl');

  function setStatus(msg){ statusEl.textContent = msg; }

  const ua = navigator.userAgent || '';
  const isWeChat = /MicroMessenger/i.test(ua);
  const isMobile = /Android|iPhone|iPad|iPod|Adr/i.test(ua);

  // optional global config injected by backend:
  // window.WX_PAY_CONFIG = { wxConfig: {...}, payParams: {...} }
  async function initWxSdkFromConfig(wxConf) {
    if (!window.wx || !wxConf || !wxConf.wxConfig) return Promise.reject('no-wx-or-config');
    return new Promise((resolve, reject) => {
      try {
        wx.config({
          debug: false,
          appId: wxConf.wxConfig.appId,
          timestamp: wxConf.wxConfig.timestamp,
          nonceStr: wxConf.wxConfig.nonceStr,
          signature: wxConf.wxConfig.signature,
          jsApiList: ['chooseWXPay']
        });
        wx.ready(() => resolve(true));
        wx.error(err => reject(err));
      } catch (e) { reject(e); }
    });
  }

  function tryWxChoosePay(payParams) {
    if (!window.wx || !payParams) return Promise.reject('no-wx-or-payParams');
    return new Promise((resolve, reject) => {
      try {
        wx.chooseWXPay({
          timestamp: payParams.timestamp,
          nonceStr: payParams.nonceStr,
          package: payParams.package,
          signType: payParams.signType || 'MD5',
          paySign: payParams.paySign,
          success(res){ resolve(res); },
          cancel(res){ reject({type:'cancel', info:res}); },
          fail(err){ reject({type:'fail', info:err}); }
        });
      } catch (e) { reject(e); }
    });
  }

  // deep link 唤醒（在移动端由用户点击触发）
  function tryDeepLink(deepLink, timeout = 1200) {
    return new Promise((resolve, reject) => {
      if (!deepLink || typeof deepLink !== 'string') return reject('invalid-link');

      // basic sanitize: remove backslashes and whitespace
      deepLink = deepLink.replace(/\\/g,'').trim();

      // only allow expected prefix
      if (!/^weixin:\/\/wxpay\/bizpayurl\?pr=[A-Za-z0-9_\-]+$/i.test(deepLink)) {
        return reject('link-format-invalid');
      }

      if (!isMobile) return reject('not-mobile');

      let opened = false;
      const onVis = () => { opened = true; };
      document.addEventListener('visibilitychange', onVis);

      // create anchor and click
      const a = document.createElement('a');
      a.href = deepLink;
      a.style.display = 'none';
      document.body.appendChild(a);

      try {
        a.click();
      } catch (e) {
        try { window.location.href = deepLink; } catch(e2) {}
      }

      // after timeout determine result
      setTimeout(() => {
        document.removeEventListener('visibilitychange', onVis);
        try { a.remove(); } catch(e){}
        if (opened) resolve(true);
        else reject('not-opened');
      }, timeout);
    });
  }

  // show a quick QR (Google Chart)
  function showQr(text) {
    const url = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chld=L|1&chl=' + encodeURIComponent(text);
    qrEl.innerHTML = '<div><p>若唤醒失败，请用微信扫一扫：</p><img class="qr" src="' + url + '" alt="qr"></div>';
  }

  // main flow when clicking button
  payBtn.addEventListener('click', async function(){
    setStatus('开始支付流程...');
    qrEl.innerHTML = '';

    const raw = (payUrlInput.value || '').replace(/\\+/g, '').trim();

    // 1) If in WeChat and backend provided WX_PAY_CONFIG, try JSAPI
    if (isWeChat && window.WX_PAY_CONFIG && window.WX_PAY_CONFIG.payParams) {
      setStatus('检测到微信环境与 JSAPI 参数，尝试调用 wx.chooseWXPay ...');
      try {
        // If wx.config not yet init, attempt init with provided wxConfig
        if (window.WX_PAY_CONFIG.wxConfig) {
          await initWxSdkFromConfig(window.WX_PAY_CONFIG);
        }
        await tryWxChoosePay(window.WX_PAY_CONFIG.payParams);
        setStatus('JSAPI：支付调用已发起，请在微信中完成支付。');
        return;
      } catch (e) {
        console.warn('wx jsapi fail', e);
        setStatus('JSAPI 调用失败，尝试回退唤醒或二维码。');
        // fallthrough to deep link / qr
      }
    }

    // 2) Try deep link (mobile)
    if (isMobile) {
      setStatus('尝试通过 deep link 唤醒微信...');
      try {
        await tryDeepLink(raw, 1500);
        setStatus('若已切换到微信，请完成支付；若未切换请扫码或在微信中打开此页。');
        return;
      } catch (e) {
        console.warn('deep link fail', e);
        setStatus('唤醒未成功，显示二维码作为回退。');
        showQr(raw);
        return;
      }
    }

    // 3) Desktop or others: show QR fallback
    setStatus('当前为桌面或非移动环境，请用手机微信扫码支付。');
    showQr(raw);
  });

})();
</script>
</body>
</html>
