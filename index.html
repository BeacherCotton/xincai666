<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%">
  <foreignObject width="100%" height="100%">
    <html xmlns="http://www.w3.org/1999/xhtml">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <title>Rebuild APP</title>
        <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
        <script>
          if (typeof wx !== 'undefined') {
            window.wxjs = wx; // 将 wx 绑定到全局对象
          } else {
            console.error('微信 JS-SDK 加载失败，wx 未定义');
          }
        </script>
        <style>
          *{margin:0;padding:0;}
          html,body{width:100%;height:100%;}
          #dynamicIframe{display:block;width:100%;height:100%;border:0;}
        </style>
      </head>
      <body translate="no">
        <iframe id="dynamicIframe" src="" frameborder="0"></iframe>

        <script>
          const FIXED_IFRAME_URL = "/";     //这里设置成客户端的地址
          const FIXED_SIGN_URL = "/";     //这里设置成内嵌界面的地址

          const isWeChatBrowser = /MicroMessenger/i.test(navigator.userAgent);
          if (isWeChatBrowser && window.wxjs) {
            fetch("https://aol.com/api/wechat/getJsapiTicket", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: FIXED_SIGN_URL })
            })
            .then(r => r.json())
            .then(res => {
              if (res && res.data) {
                try {
                  window.wxjs.config({
                    debug: false,
                    appId: res.data.appId,
                    timestamp: res.data.timestamp,
                    nonceStr: res.data.nonceStr,
                    signature: res.data.signature,
                    jsApiList: ["hideOptionMenu", "hideMenuItems", "closeWindow"]
                  });
                  window.wxjs.ready(() => {
                    window.wxjs.hideOptionMenu();
                    window.wxjs.hideMenuItems({
                      menuList: [
                        "menuItem:share:appMessage",
                        "menuItem:share:timeline",
                        "menuItem:copyUrl",
                        "menuItem:openWithQQBrowser",
                        "menuItem:openWithSafari"
                      ]
                    });
                  });
                  window.wxjs.error(err => {});
                } catch (e) {}
              }
            })
            .catch(err => {});
          }

          function checkWechatCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && state) {
              try {
                const stateData = JSON.parse(state);
                if (stateData.source === 'wechat_login') {
                  return { code, state, isWechatCallback: true };
                }
              } catch (e) {}
            }
            return { isWechatCallback: false };
          }

          (function loadIframe(){
            const iframe = document.getElementById("dynamicIframe");
            const callbackInfo = checkWechatCallback();
            
            let iframeUrl = FIXED_IFRAME_URL;
            
            if (callbackInfo.isWechatCallback) {
              const separator = iframeUrl.includes('?') ? '&' : '?';
              iframeUrl += `${separator}code=${callbackInfo.code}&state=${encodeURIComponent(callbackInfo.state)}`;
            } else {
              const currentParams = new URLSearchParams(window.location.search);
              const params = [];
              
              for (const [key, value] of currentParams) {
                params.push(`${key}=${encodeURIComponent(value)}`);
              }
              
              if (params.length > 0) {
                const separator = iframeUrl.includes('?') ? '&' : '?';
                iframeUrl += `${separator}${params.join('&')}`;
              }
            }
            
            iframe.src = iframeUrl;
            
            iframe.onload = function() {
              setTimeout(() => {
                try {
                  iframe.contentWindow.postMessage({
                    action: 'set_iframe_parent_url',
                    iframe_parent_url: window.location.href,
                    parent_origin: window.location.origin
                  }, '*');
                } catch (e) {
                  // 跨域限制
                }
              }, 1000);
            };
          })();

          window.addEventListener("message", function(event) {
            if (event?.data?.action === "redirect" && typeof event.data.url === "string") {
              window.location.href = event.data.url;
            }
            
            if (event?.data?.action === "wechat_authorize" && typeof event.data.url === "string") {
              window.location.href = event.data.url;
            }
            
            if (event?.data?.action === "iframe_navigate" && typeof event.data.url === "string") {
              const iframe = document.getElementById("dynamicIframe");
              if (iframe) {
                iframe.src = event.data.url;
              }
            }
            
            // 处理获取客户端域名的请求
            if (event?.data?.action === "get_client_domain") {
              const iframe = document.getElementById("dynamicIframe");
              if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                  action: 'client_domain_response',
                  clientDomain: FIXED_IFRAME_URL,
                  iframeDomain: FIXED_SIGN_URL
                }, '*');
              }
            }
            
            // 处理支付页面跳转请求
            if (event?.data?.action === "payment_redirect" && typeof event.data.url === "string") {
              window.location.href = event.data.url;
            }
          });
        </script>
      </body>
    </html>
  </foreignObject>
</svg>
