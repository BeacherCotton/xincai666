<iframe id="dynamicIframe" src="" frameborder="0" style="width:100%;height:100%;"></iframe>
<script>
const FIXED_IFRAME_URL = "https://h5.hlll.org/";          // H5 客户端
const FIXED_PARENT_URL = "https://beachercotton.github.io/xincai666/"; // 外层 GitHub

function checkWechatCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    if (code && state) {
        try {
            const stateData = JSON.parse(decodeURIComponent(state));
            if (stateData.source === 'wechat_login') {
                return { code, state, isWechatCallback: true };
            }
        } catch(e){}
    }
    return { isWechatCallback: false };
}

(function loadIframe(){
    const iframe = document.getElementById("dynamicIframe");
    const callbackInfo = checkWechatCallback();
    let iframeUrl = FIXED_IFRAME_URL;

    if (callbackInfo.isWechatCallback) {
        const sep = iframeUrl.includes('?') ? '&' : '?';
        iframeUrl += `${sep}code=${callbackInfo.code}&state=${encodeURIComponent(callbackInfo.state)}`;
    } else {
        const params = [];
        for (const [k,v] of new URLSearchParams(window.location.search)) {
            params.push(`${k}=${encodeURIComponent(v)}`);
        }
        if (params.length > 0) {
            const sep = iframeUrl.includes('?') ? '&' : '?';
            iframeUrl += `${sep}${params.join('&')}`;
        }
    }

    iframe.src = iframeUrl;

    iframe.onload = function(){
        setTimeout(()=>{
            try {
                // 通知 iframe 自己外层父地址
                iframe.contentWindow.postMessage({
                    action: 'set_iframe_parent_url',
                    iframe_parent_url: FIXED_PARENT_URL
                }, '*');
            } catch(e){}
        },1000);
    };
})();

window.addEventListener("message", function(event){
    // 所有跳转都在 iframe 内部处理，不跳出外层
    if(event?.data?.action === "iframe_navigate" && typeof event.data.url === "string"){
        const iframe = document.getElementById("dynamicIframe");
        if(iframe) iframe.src = event.data.url;
    }
});
</script>
